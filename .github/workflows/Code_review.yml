name: Code Review

on:
  pull_request:
    branches: [ "main" ]
  workflow_dispatch:

permissions:
  contents: read

jobs:
  review:
    runs-on: ubuntu-latest
    # Skip PRs from forks (no secrets available)
    if: ${{ github.event.pull_request.head.repo.fork == false }}
    steps:
      - uses: actions/checkout@v4

      - name: Run Curie review
        env:
          CURIE_API_KEY: ${{ secrets.CURIE_API_KEY }}
        run: |
          set -euo pipefail
          # Build JSON safely
          payload=$(jq -n \
            --arg org_name "CurieTech-demo" \
            --arg repo_name "${GITHUB_REPOSITORY#*/}" \
            --arg branch_name "${{ github.head_ref }}" \
            --argjson pr_number ${{ github.event.pull_request.number }} \
            --arg prompt "CI-triggered code review" \
            '{conn_type:"github", org_name:$org_name, repo_name:$repo_name, branch_name:$branch_name, pr_number:$pr_number, prompt:$prompt}')

          curl -sS --fail -X POST "https://platform.curietech.ai/api/code-review/run" \
            -H "Authorization: Bearer ${CURIE_API_KEY}" \
            -H "Content-Type: application/json" \
            -d "$payload"
